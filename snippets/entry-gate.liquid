{%- comment -%}
Site‑wide “Guest or Create Account” + 21+ gate (New Customer Accounts)
- Toggleable via Theme settings
- Optional welcome discount deep-link
- Remembers for N days (Theme setting)
{%- endcomment -%}

{%- assign gate_enabled = settings.ss_gate_enable | default: true -%}
{%- assign on_account_page = request.path contains '/account' -%}

{%- if gate_enabled and customer == nil and on_account_page == false -%}
  {%- assign cookie_days = settings.ss_gate_cookie_days | default: 30 -%}
  {%- assign cookie_max_age = cookie_days | times: 86400 -%}

  {%- assign title = settings.ss_gate_title | default: 'Welcome to Surgeons — Please Verify' -%}
  {%- assign subtext = settings.ss_gate_subtext | default: 'You must be 21+ to purchase. Continue as a guest or create an account to unlock perks.' -%}
  {%- assign guest_text = settings.ss_gate_guest_text | default: 'Continue as Guest' -%}
  {%- assign cta_text = settings.ss_gate_cta_text | default: 'Create Account & Save 10%' -%}
  {%- assign discount_code = settings.ss_gate_discount_code -%}

  {%- assign ret = request.path -%}
  {%- if discount_code and discount_code != blank -%}
    {%- assign discount_path = '/discount/' | append: discount_code | append: '?return_url=' | append: ret | url_encode -%}
    {%- assign account_href = '/account?return_url=' | append: discount_path | url_encode -%}
  {%- else -%}
    {%- assign account_href = '/account?return_url=' | append: ret | url_encode -%}
  {%- endif -%}

  <style>
    .ss-gate__backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:9999}
    .ss-gate__card{background:#fff;max-width:560px;width:92%;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.25);padding:24px}
    .ss-gate__title{font-size:1.4rem;font-weight:700;margin:0 0 8px}
    .ss-gate__p{margin:0 0 12px;line-height:1.45}
    .ss-gate__age{display:flex;gap:8px;align-items:center;margin:8px 0 16px}
    .ss-gate__row{display:flex;gap:12px;flex-wrap:wrap}
    .ss-btn{flex:1;min-width:180px;display:inline-flex;align-items:center;justify-content:center;border-radius:999px;padding:12px 16px;border:1px solid #222;font-weight:600;cursor:not-allowed;opacity:.5}
    .ss-btn--primary{background:#e02424;color:#fff;border-color:#e02424}
    .ss-btn[aria-disabled="false"]{cursor:pointer;opacity:1}
    @media (prefers-color-scheme: dark){
      .ss-gate__card{background:#111;color:#f2f2f2}
      .ss-btn{border-color:#444;color:#f2f2f2}
    }
  </style>

  <div id="ss-gate" class="ss-gate__backdrop" role="dialog" aria-modal="true" aria-labelledby="ss-gate-title">
    <div class="ss-gate__card">
      <h2 id="ss-gate-title" class="ss-gate__title">{{ title }}</h2>
      <p class="ss-gate__p">{{ subtext }}</p>
      <label class="ss-gate__age">
        <input id="ss-age-ok" type="checkbox" />
        <span>I confirm I am <strong>21 years of age</strong> or older.</span>
      </label>
      <div class="ss-gate__row">
        <button id="ss-guest" class="ss-btn" aria-disabled="true">{{ guest_text }}</button>
        <a id="ss-create" class="ss-btn ss-btn--primary" aria-disabled="true" href="{{ account_href }}">{{ cta_text }}</a>
      </div>
      {%- if discount_code and discount_code != blank -%}
        <p class="ss-gate__p" style="font-size:.9rem;opacity:.8;margin-top:10px">
          Members get a welcome discount with code <strong>{{ discount_code }}</strong>, faster checkout, rewards, and order history.
        </p>
      {%- else -%}
        <p class="ss-gate__p" style="font-size:.9rem;opacity:.8;margin-top:10px">
          Account members get <strong>exclusive promos</strong>, faster checkout, rewards, and order history.
        </p>
      {%- endif -%}
    </div>
  </div>

  <script>
    (function(){
      var COOKIE_NAME = "ss_gate";
      var MAX_AGE = {{ cookie_max_age | json }};

      function setCookie(name, value, maxAge) {
        document.cookie = name + "=" + encodeURIComponent(value) + "; path=/; max-age=" + maxAge + "; SameSite=Lax";
      }
      function getCookie(name) {
        return document.cookie.split("; ").reduce(function(acc, c){
          var p = c.split("="); acc[p[0]] = p.slice(1).join("="); return acc;
        }, {})[name];
      }

      if (!getCookie(COOKIE_NAME)) {
        var backdrop = document.getElementById("ss-gate");
        var age = document.getElementById("ss-age-ok");
        var guest = document.getElementById("ss-guest");
        var create = document.getElementById("ss-create");

        function setBtns(enabled){
          guest.setAttribute("aria-disabled", enabled ? "false" : "true");
          create.setAttribute("aria-disabled", enabled ? "false" : "true");
          if (enabled) { guest.removeAttribute("disabled"); } else { guest.setAttribute("disabled","disabled"); }
        }

        setBtns(false);
        age.addEventListener("change", function(){ setBtns(!!age.checked); });

        guest.addEventListener("click", function(e){
          if (age.checked) {
            setCookie(COOKIE_NAME, "1", MAX_AGE);
            backdrop.style.display = "none";
            document.documentElement.style.overflow = "";
          } else {
            e.preventDefault();
          }
        });

        create.addEventListener("click", function(e){
          if (!age.checked) e.preventDefault();
          else setCookie(COOKIE_NAME, "1", MAX_AGE);
        });

        backdrop.style.display = "flex";
        document.documentElement.style.overflow = "hidden";
      }
    })();
  </script>
{%- endif -%}
